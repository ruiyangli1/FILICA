---
title: "Demo"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Demo}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE, eval = TRUE, 
  comment = "#>"
)
```

The FILICA package conducts the multimodal fusion using LICA while addressing the missing data problem. 

# Note

* Working directory should be set at the current `FILICA` folder
* LICA is implemented using [MATLAB functions](https://fsl.fmrib.ox.ac.uk/fsl/fslwiki/FLICA), which will be called from R
* All the MATLAB functions and code scripts are in the folder `./MATLAB_code/flica`, which should be placed under the `FILICA` folder
* MATLAB scripts to run LICA are named as `code_*.m`. ***Please make sure to change the path to `your path/FILICA/MATLAB_code/flica` in each script based on your folder location!***

# Load packages

```{r setup, message=FALSE,warning=FALSE}
sessionInfo()[[1]][[13]]

library(FILICA)
library(tidyverse)
library(matlabr)     # run matlab script
library(R.matlab)    # read matlab data formats into R

library(scales)      # plot dF curve
breaks_log10 <- function(x) {
  low <- floor(log10(min(x)))
  high <- ceiling(log10(max(x)))
  10^(seq.int(low, high))
}
```

# MAR setting 

* n = 100
* miss 5% of data

## LICA on no-missing data
```{r fig.width = 7, fig.height = 5}
# generate data
data = data_generate_MAR(nsubj = 100, seed = 7452, n_miss = 5) #--- n_miss doesn't matter b/c will only use no-miss data from data_generate()
  
# no-miss data
mod1_true = data$Y1
mod2_true = data$Y2

# true components
H_true = data$H
H_true_trans = t(H_true); colnames(H_true_trans) = paste0("true_comp", 1:ncol(H_true_trans))
XWstack_true = rbind(data$XW1, data$XW2)

# standardize no-miss data
mod1_true_std = data_standardization(mod1_true)
mod2_true_std = data_standardization(mod2_true)
  
# save data
writeMat("./MATLAB_code/flica/data_nomiss.mat", 
         mod1_true = mod1_true, mod2_true = mod2_true,                # simulated data w/ no missing
         mod1_true_std = mod1_true_std, mod2_true_std = mod2_true_std # simulated data w/ no missing after standardization
         )

# LICA 
message("< Running LICA on no-miss data >")
re_nomiss = flica_nomiss(ncomp = 5, flica_niter = 1500)
  
## last dF
last_dF = re_nomiss$F.history[,length(re_nomiss$F.history)]-re_nomiss$F.history[,length(re_nomiss$F.history)-1]
message("Last dF = ", last_dF)
    
## H
H_nomiss = re_nomiss$H
H_nomiss_trans = t(H_nomiss); colnames(H_nomiss_trans) = paste0("est_comp", 1:ncol(H_nomiss_trans))
    
## concatenated XW
XWstack_nomiss = do.call(rbind, lapply(1:2, function(k){ 
  re_nomiss[["X"]][[k]][[1]] %*% diag( as.vector(re_nomiss[["W"]][[k]][[1]]) ) 
  }))
colnames(XWstack_nomiss) = paste0("est_comp", 1:5)

## identify most cor component with true XW
cor(XWstack_true, XWstack_nomiss)
bestIC(XWstack_true, XWstack_nomiss)

## dF curve
F_hist = t(re_nomiss$F.history)
F_hist_lag = lag(F_hist)
dF = data.frame(dF = F_hist - F_hist_lag)
dF$index = 1:nrow(dF)
dF %>% 
  ggplot(aes(x = index, y = dF)) + 
  geom_point(alpha = 0.5) + 
  geom_path() + 
  annotation_logticks() +
  scale_x_log10(breaks = breaks_log10,labels = trans_format(log10, math_format(10^.x))) +
  scale_y_log10(breaks = breaks_log10,labels = trans_format(log10, math_format(10^.x))) +
  labs(title = "dF curve") + 
  geom_hline(yintercept = 0.1, linetype = "dashed", color = "blue") + 
  theme_classic()
```

## LICA on data after replacing missing with 0
```{r fig.width = 7, fig.height = 5}
# generate data
data = data_generate_MAR(nsubj = 100, seed = 7452, n_miss = 5) 
  
# true components
H_true = data$H
H_true_trans = t(H_true); colnames(H_true_trans) = paste0("true_comp", 1:ncol(H_true_trans))
XWstack_true = rbind(data$XW1, data$XW2)

# assigned missing subjects
subj1_miss = data$subj1_miss
subj2_miss = data$subj2_miss
  
# miss-data: with NA for assigned missing subjects
mod1_miss = data$Y1_miss
mod2_miss = data$Y2_miss

# replace NA w/ 0
mod1_replace0 = mod1_miss; mod1_replace0[,subj1_miss] = 0
mod2_replace0 = mod2_miss; mod2_replace0[,subj2_miss] = 0

# standardize replace0 data
mod1_replace0_std = data_standardization(mod1_replace0)
mod2_replace0_std = data_standardization(mod2_replace0)

# save data
# replace NA w/ 0
writeMat("./MATLAB_code/flica/data_replace0.mat", 
         mod1_miss = mod1_replace0, mod2_miss = mod2_replace0,      # data with missing as 0
         mod1_std = mod1_replace0_std, mod2_std = mod2_replace0_std # data with missing as 0 after standardization
)

# LICA 
message("< Running current practice: replace NA with 0 + LICA >")
message("( ", 1500, " iterations )")

re_replace0 = try(flica_replace0(ncomp = 5, flica_niter = 1500))

# in case LICA stop early, reduce flica_niter (by 25%) and rerun LICA until it works
# stop if reduce 18 times but still not work
flica_niter_used = 1500
stop_count = 1
while (class(re_replace0) == "try-error" & stop_count <= 18) {
  flica_niter_used = ceiling(0.75 * flica_niter_used)
  message("< Re-running LICA > ( ", flica_niter_used, " iterations )")
  re_replace0 = try(flica_replace0(ncomp = 5, flica_niter = flica_niter_used))
  stop_count = stop_count + 1
}

## last dF
last_dF = re_replace0$F.history[,length(re_replace0$F.history)]-re_replace0$F.history[,length(re_replace0$F.history)-1]
message("Last dF = ", last_dF)
    
## H
H_replace0 = re_replace0$H
H_replace0_trans = t(H_replace0); colnames(H_replace0_trans) = paste0("est_comp", 1:ncol(H_replace0_trans))

## concatenated XW
XWstack_replace0 = do.call(rbind, lapply(1:2, function(k){ 
  re_replace0[["X"]][[k]][[1]] %*% diag( as.vector(re_replace0[["W"]][[k]][[1]]) ) 
  }))
colnames(XWstack_replace0) = paste0("est_comp", 1:5)

## dF curve
F_hist = t(re_replace0$F.history)
F_hist_lag = lag(F_hist)
dF = data.frame(dF = F_hist - F_hist_lag)
dF$index = 1:nrow(dF)
dF %>% 
  ggplot(aes(x = index, y = dF)) + 
  geom_point(alpha = 0.5) + 
  geom_path() + 
  annotation_logticks() +
  scale_x_log10(breaks = breaks_log10,labels = trans_format(log10, math_format(10^.x))) +
  scale_y_log10(breaks = breaks_log10,labels = trans_format(log10, math_format(10^.x))) +
  labs(title = "dF curve") + 
  geom_hline(yintercept = 0.1, linetype = "dashed", color = "blue") + 
  theme_classic()
```

## LICA on completers
```{r fig.width = 7, fig.height = 5}
# generate data
data = data_generate_MAR(nsubj = 100, seed = 7452, n_miss = 5) 
  
# true components
H_true = data$H
H_true_trans = t(H_true); colnames(H_true_trans) = paste0("true_comp", 1:ncol(H_true_trans))
XWstack_true = rbind(data$XW1, data$XW2)

# assigned missing subjects
subj1_miss = data$subj1_miss
subj2_miss = data$subj2_miss
  
# miss-data: with NA for assigned missing subjects
mod1_miss = data$Y1_miss
mod2_miss = data$Y2_miss

# standardize missing data (step 0)
mod1_std = data_standardization(mod1_miss)
mod2_std = data_standardization(mod2_miss)
# prepare std data by mod k, for ease of computation
mod_std = NULL
mod_std[[1]] = mod1_std
mod_std[[2]] = mod2_std

# keep complete data from the standardized missing data
mod_std_complete = data_complete(mod_std)
mod1_std_cmplt = mod_std_complete[[1]]
mod2_std_cmplt = mod_std_complete[[2]]

# save data
# completer
writeMat("./MATLAB_code/flica/data_std.mat", 
         mod1_std = mod1_std, mod2_std = mod2_std, # data with missing as NA after standardization
         mod1_std_cmplt = mod1_std_cmplt, mod2_std_cmplt = mod2_std_cmplt #complete data from above
)

# LICA 
message("< Running LICA on completers >")
message("( ", 1500, " iterations )")

re_completer = flica_completer(ncomp = 5, flica_niter = 1500)

## last dF
last_dF = re_completer$F.history[,length(re_completer$F.history)]-re_completer$F.history[,length(re_completer$F.history)-1]
message("Last dF = ", last_dF)

## H
H_completer = re_completer$H
H_completer_trans = t(H_completer); colnames(H_completer_trans) = paste0("est_comp", 1:ncol(H_completer_trans))

## concatenated XW
XWstack_completers = do.call(rbind, lapply(1:2, function(k){ 
  re_completer[["X"]][[k]][[1]] %*% diag( as.vector(re_completer[["W"]][[k]][[1]]) ) 
  }))
colnames(XWstack_completers) = paste0("est_comp", 1:5)

## dF curve
F_hist = t(re_completer$F.history)
F_hist_lag = lag(F_hist)
dF = data.frame(dF = F_hist - F_hist_lag)
dF$index = 1:nrow(dF)
dF %>% 
  ggplot(aes(x = index, y = dF)) + 
  geom_point(alpha = 0.5) + 
  geom_path() + 
  annotation_logticks() +
  scale_x_log10(breaks = breaks_log10,labels = trans_format(log10, math_format(10^.x))) +
  scale_y_log10(breaks = breaks_log10,labels = trans_format(log10, math_format(10^.x))) +
  labs(title = "dF curve") + 
  geom_hline(yintercept = 0.1, linetype = "dashed", color = "blue") + 
  theme_classic()
```

## FI-LICA

* current implementation of FI-LICA Step 1 needs the results from the completer analysis above

```{r fig.width = 7, fig.height = 3}
# generate data
data = data_generate_MAR(nsubj = 100, seed = 7452, n_miss = 5) 
  
# true components
H_true = data$H
H_true_trans = t(H_true); colnames(H_true_trans) = paste0("true_comp", 1:ncol(H_true_trans))
XWstack_true = rbind(data$XW1, data$XW2)

# assigned missing subjects
subj1_miss = data$subj1_miss
subj2_miss = data$subj2_miss
# prepare subj by mod k, for ease of computation
subj_miss = NULL; 
subj_miss[[1]] = subj1_miss 
subj_miss[[2]] = subj2_miss
  
# miss-data: with NA for assigned missing subjects
mod1_miss = data$Y1_miss
mod2_miss = data$Y2_miss

# standardize missing data (step 0)
mod1_std = data_standardization(mod1_miss)
mod2_std = data_standardization(mod2_miss)
# prepare std data by mod k, for ease of computation
mod_std = NULL
mod_std[[1]] = mod1_std
mod_std[[2]] = mod2_std

# keep complete data from the standardized missing data (for step 1)
mod_std_complete = data_complete(mod_std)
mod1_std_cmplt = mod_std_complete[[1]]
mod2_std_cmplt = mod_std_complete[[2]]

# ---- FI-LICA ---- 
message("< Running FI-LICA >")

# run step 1: loaded from completer case analysis 
re_step1 = filica_step1(re = re_completer, rescale = TRUE)
message("check: dF = ", re_step1$last_dF)
# results from step 1
H_prev = re_step1$H
XW_prev = re_step1$XW

# run step 2
message("Step 2: ( ", 20, " updates + ", 1000, " niter )")
re_step2 = filica_step2(n = 20, ncomp = 5, flica_niter2 = 1000, H_prev = H_prev, XW_prev = XW_prev, rescale = TRUE)
re_filica = re_step2

# results
## number of modality
mod_n = length(re_filica$results[["X"]])
## H
H_filica = re_filica$results$H
H_filica_trans = t(H_filica); colnames(H_filica_trans) = paste0("est_comp", 1:ncol(H_filica_trans))
## concatenated XW
XW_filica = do.call(rbind, lapply(1:mod_n, function(k){ 
  re_filica$results[["X"]][[k]][[1]] %*% diag( as.vector(re_filica$results[["W"]][[k]][[1]]) ) 
  }))
colnames(XW_filica) = paste0("est_comp", 1:5)

## convergence
par(mfrow=c(1,2))
plot(re_filica$H_convergence, ylab = "H_convergence", type="l")
plot(re_filica$XW_convergence, ylab = "XW_convergence", type="l")
```
```{r fig.width = 11, fig.height = 9}
## dF curve
F_hist = re_filica$F_hist
F_hist_lag = lag(F_hist)
dF = data.frame(F_hist - F_hist_lag)
colnames(dF) = paste0("update", 1:20)
dF$index = 1:nrow(dF)
dF %>% 
  pivot_longer(1:20, names_to = "update", values_to = "dF") %>% 
  mutate(update = factor(update,levels = paste0("update",1:20))) %>% 
  filter(update %in% c(paste0("update",1:20))) %>% 
  ggplot(aes(x = index, y = dF)) + 
  geom_point(alpha = 0.5) + 
  geom_path() + 
  facet_wrap(~update) +
  annotation_logticks() +
  scale_x_log10(breaks = breaks_log10,labels = trans_format(log10, math_format(10^.x))) +
  scale_y_log10(breaks = breaks_log10,labels = trans_format(log10, math_format(10^.x))) +
  labs(title = "dF curve in FI-LICA Step 2") + 
  geom_hline(yintercept = 0.1, linetype = "dashed", color = "blue") + 
  theme_classic()
```



# MCAR setting

* n = 100
* miss 5% of data

## LICA on no-missing data
```{r fig.width = 7, fig.height = 5}
# generate data
data = data_generate_MCAR(nsubj = 100, seed = 7452, n_miss = 5) #--- n_miss doesn't matter b/c will only use no-miss data from data_generate()
  
# no-miss data
mod1_true = data$Y1
mod2_true = data$Y2

# true components
H_true = data$H
H_true_trans = t(H_true); colnames(H_true_trans) = paste0("true_comp", 1:ncol(H_true_trans))
XWstack_true = rbind(data$XW1, data$XW2)

# standardize no-miss data
mod1_true_std = data_standardization(mod1_true)
mod2_true_std = data_standardization(mod2_true)
  
# save data
writeMat("./MATLAB_code/flica/data_nomiss.mat", 
         mod1_true = mod1_true, mod2_true = mod2_true,                # simulated data w/ no missing
         mod1_true_std = mod1_true_std, mod2_true_std = mod2_true_std # simulated data w/ no missing after standardization
         )

# LICA 
message("< Running LICA on no-miss data >")
re_nomiss = flica_nomiss(ncomp = 5, flica_niter = 1500)
  
## last dF
last_dF = re_nomiss$F.history[,length(re_nomiss$F.history)]-re_nomiss$F.history[,length(re_nomiss$F.history)-1]
message("Last dF = ", last_dF)
    
## H
H_nomiss = re_nomiss$H
H_nomiss_trans = t(H_nomiss); colnames(H_nomiss_trans) = paste0("est_comp", 1:ncol(H_nomiss_trans))
    
## concatenated XW
XWstack_nomiss = do.call(rbind, lapply(1:2, function(k){ 
  re_nomiss[["X"]][[k]][[1]] %*% diag( as.vector(re_nomiss[["W"]][[k]][[1]]) ) 
  }))
colnames(XWstack_nomiss) = paste0("est_comp", 1:5)

## identify most cor component with true XW
cor(XWstack_true, XWstack_nomiss)
bestIC(XWstack_true, XWstack_nomiss)

## dF curve
F_hist = t(re_nomiss$F.history)
F_hist_lag = lag(F_hist)
dF = data.frame(dF = F_hist - F_hist_lag)
dF$index = 1:nrow(dF)
dF %>% 
  ggplot(aes(x = index, y = dF)) + 
  geom_point(alpha = 0.5) + 
  geom_path() + 
  annotation_logticks() +
  scale_x_log10(breaks = breaks_log10,labels = trans_format(log10, math_format(10^.x))) +
  scale_y_log10(breaks = breaks_log10,labels = trans_format(log10, math_format(10^.x))) +
  labs(title = "dF curve") + 
  geom_hline(yintercept = 0.1, linetype = "dashed", color = "blue") + 
  theme_classic()
```

## LICA on data after replacing missing with 0
```{r fig.width = 7, fig.height = 5}
# generate data
data = data_generate_MCAR(nsubj = 100, seed = 7452, n_miss = 5) 
  
# true components
H_true = data$H
H_true_trans = t(H_true); colnames(H_true_trans) = paste0("true_comp", 1:ncol(H_true_trans))
XWstack_true = rbind(data$XW1, data$XW2)

# assigned missing subjects
subj1_miss = data$subj1_miss
subj2_miss = data$subj2_miss
  
# miss-data: with NA for assigned missing subjects
mod1_miss = data$Y1_miss
mod2_miss = data$Y2_miss

# replace NA w/ 0
mod1_replace0 = mod1_miss; mod1_replace0[,subj1_miss] = 0
mod2_replace0 = mod2_miss; mod2_replace0[,subj2_miss] = 0

# standardize replace0 data
mod1_replace0_std = data_standardization(mod1_replace0)
mod2_replace0_std = data_standardization(mod2_replace0)

# save data
# replace NA w/ 0
writeMat("./MATLAB_code/flica/data_replace0.mat", 
         mod1_miss = mod1_replace0, mod2_miss = mod2_replace0,      # data with missing as 0
         mod1_std = mod1_replace0_std, mod2_std = mod2_replace0_std # data with missing as 0 after standardization
)

# LICA 
message("< Running current practice: replace NA with 0 + LICA >")
message("( ", 1500, " iterations )")

re_replace0 = try(flica_replace0(ncomp = 5, flica_niter = 1500))

# in case LICA stop early, reduce flica_niter (by 25%) and rerun LICA until it works
# stop if reduce 18 times but still not work
flica_niter_used = 1500
stop_count = 1
while (class(re_replace0) == "try-error" & stop_count <= 18) {
  flica_niter_used = ceiling(0.75 * flica_niter_used)
  message("< Re-running LICA > ( ", flica_niter_used, " iterations )")
  re_replace0 = try(flica_replace0(ncomp = 5, flica_niter = flica_niter_used))
  stop_count = stop_count + 1
}

## last dF
last_dF = re_replace0$F.history[,length(re_replace0$F.history)]-re_replace0$F.history[,length(re_replace0$F.history)-1]
message("Last dF = ", last_dF)
    
## H
H_replace0 = re_replace0$H
H_replace0_trans = t(H_replace0); colnames(H_replace0_trans) = paste0("est_comp", 1:ncol(H_replace0_trans))

## concatenated XW
XWstack_replace0 = do.call(rbind, lapply(1:2, function(k){ 
  re_replace0[["X"]][[k]][[1]] %*% diag( as.vector(re_replace0[["W"]][[k]][[1]]) ) 
  }))
colnames(XWstack_replace0) = paste0("est_comp", 1:5)

## dF curve
F_hist = t(re_replace0$F.history)
F_hist_lag = lag(F_hist)
dF = data.frame(dF = F_hist - F_hist_lag)
dF$index = 1:nrow(dF)
dF %>% 
  ggplot(aes(x = index, y = dF)) + 
  geom_point(alpha = 0.5) + 
  geom_path() + 
  annotation_logticks() +
  scale_x_log10(breaks = breaks_log10,labels = trans_format(log10, math_format(10^.x))) +
  scale_y_log10(breaks = breaks_log10,labels = trans_format(log10, math_format(10^.x))) +
  labs(title = "dF curve") + 
  geom_hline(yintercept = 0.1, linetype = "dashed", color = "blue") + 
  theme_classic()
```

## LICA on completers
```{r fig.width = 7, fig.height = 5}
# generate data
data = data_generate_MCAR(nsubj = 100, seed = 7452, n_miss = 5) 
  
# true components
H_true = data$H
H_true_trans = t(H_true); colnames(H_true_trans) = paste0("true_comp", 1:ncol(H_true_trans))
XWstack_true = rbind(data$XW1, data$XW2)

# assigned missing subjects
subj1_miss = data$subj1_miss
subj2_miss = data$subj2_miss
  
# miss-data: with NA for assigned missing subjects
mod1_miss = data$Y1_miss
mod2_miss = data$Y2_miss

# standardize missing data (step 0)
mod1_std = data_standardization(mod1_miss)
mod2_std = data_standardization(mod2_miss)
# prepare std data by mod k, for ease of computation
mod_std = NULL
mod_std[[1]] = mod1_std
mod_std[[2]] = mod2_std

# keep complete data from the standardized missing data
mod_std_complete = data_complete(mod_std)
mod1_std_cmplt = mod_std_complete[[1]]
mod2_std_cmplt = mod_std_complete[[2]]

# save data
# completer
writeMat("./MATLAB_code/flica/data_std.mat", 
         mod1_std = mod1_std, mod2_std = mod2_std, # data with missing as NA after standardization
         mod1_std_cmplt = mod1_std_cmplt, mod2_std_cmplt = mod2_std_cmplt #complete data from above
)

# LICA 
message("< Running LICA on completers >")
message("( ", 1500, " iterations )")

re_completer = flica_completer(ncomp = 5, flica_niter = 1500)

## last dF
last_dF = re_completer$F.history[,length(re_completer$F.history)]-re_completer$F.history[,length(re_completer$F.history)-1]
message("Last dF = ", last_dF)

## H
H_completer = re_completer$H
H_completer_trans = t(H_completer); colnames(H_completer_trans) = paste0("est_comp", 1:ncol(H_completer_trans))

## concatenated XW
XWstack_completers = do.call(rbind, lapply(1:2, function(k){ 
  re_completer[["X"]][[k]][[1]] %*% diag( as.vector(re_completer[["W"]][[k]][[1]]) ) 
  }))
colnames(XWstack_completers) = paste0("est_comp", 1:5)

## dF curve
F_hist = t(re_completer$F.history)
F_hist_lag = lag(F_hist)
dF = data.frame(dF = F_hist - F_hist_lag)
dF$index = 1:nrow(dF)
dF %>% 
  ggplot(aes(x = index, y = dF)) + 
  geom_point(alpha = 0.5) + 
  geom_path() + 
  annotation_logticks() +
  scale_x_log10(breaks = breaks_log10,labels = trans_format(log10, math_format(10^.x))) +
  scale_y_log10(breaks = breaks_log10,labels = trans_format(log10, math_format(10^.x))) +
  labs(title = "dF curve") + 
  geom_hline(yintercept = 0.1, linetype = "dashed", color = "blue") + 
  theme_classic()
```

## FI-LICA

* current implementation of FI-LICA Step 1 needs the results from the completer analysis above

```{r fig.width = 7, fig.height = 3}
# generate data
data = data_generate_MCAR(nsubj = 100, seed = 7452, n_miss = 5) 
  
# true components
H_true = data$H
H_true_trans = t(H_true); colnames(H_true_trans) = paste0("true_comp", 1:ncol(H_true_trans))
XWstack_true = rbind(data$XW1, data$XW2)

# assigned missing subjects
subj1_miss = data$subj1_miss
subj2_miss = data$subj2_miss
# prepare subj by mod k, for ease of computation
subj_miss = NULL; 
subj_miss[[1]] = subj1_miss 
subj_miss[[2]] = subj2_miss
  
# miss-data: with NA for assigned missing subjects
mod1_miss = data$Y1_miss
mod2_miss = data$Y2_miss

# standardize missing data (step 0)
mod1_std = data_standardization(mod1_miss)
mod2_std = data_standardization(mod2_miss)
# prepare std data by mod k, for ease of computation
mod_std = NULL
mod_std[[1]] = mod1_std
mod_std[[2]] = mod2_std

# keep complete data from the standardized missing data (for step 1)
mod_std_complete = data_complete(mod_std)
mod1_std_cmplt = mod_std_complete[[1]]
mod2_std_cmplt = mod_std_complete[[2]]

# ---- FI-LICA ---- 
message("< Running FI-LICA >")

# run step 1: loaded from completer case analysis 
re_step1 = filica_step1(re = re_completer, rescale = TRUE)
message("check: dF = ", re_step1$last_dF)
# results from step 1
H_prev = re_step1$H
XW_prev = re_step1$XW

# run step 2
message("Step 2: ( ", 20, " updates + ", 1000, " niter )")
re_step2 = filica_step2(n = 20, ncomp = 5, flica_niter2 = 1000, H_prev = H_prev, XW_prev = XW_prev, rescale = TRUE)
re_filica = re_step2

# results
## number of modality
mod_n = length(re_filica$results[["X"]])
## H
H_filica = re_filica$results$H
H_filica_trans = t(H_filica); colnames(H_filica_trans) = paste0("est_comp", 1:ncol(H_filica_trans))
## concatenated XW
XW_filica = do.call(rbind, lapply(1:mod_n, function(k){ 
  re_filica$results[["X"]][[k]][[1]] %*% diag( as.vector(re_filica$results[["W"]][[k]][[1]]) ) 
  }))
colnames(XW_filica) = paste0("est_comp", 1:5)

## convergence
par(mfrow=c(1,2))
plot(re_filica$H_convergence, ylab = "H_convergence", type="l")
plot(re_filica$XW_convergence, ylab = "XW_convergence", type="l")
```
```{r fig.width = 11, fig.height = 9}
## dF curve
F_hist = re_filica$F_hist
F_hist_lag = lag(F_hist)
dF = data.frame(F_hist - F_hist_lag)
colnames(dF) = paste0("update", 1:20)
dF$index = 1:nrow(dF)
dF %>% 
  pivot_longer(1:20, names_to = "update", values_to = "dF") %>% 
  mutate(update = factor(update,levels = paste0("update",1:20))) %>% 
  filter(update %in% c(paste0("update",1:20))) %>% 
  ggplot(aes(x = index, y = dF)) + 
  geom_point(alpha = 0.5) + 
  geom_path() + 
  facet_wrap(~update) +
  annotation_logticks() +
  scale_x_log10(breaks = breaks_log10,labels = trans_format(log10, math_format(10^.x))) +
  scale_y_log10(breaks = breaks_log10,labels = trans_format(log10, math_format(10^.x))) +
  labs(title = "dF curve in FI-LICA Step 2") + 
  geom_hline(yintercept = 0.1, linetype = "dashed", color = "blue") + 
  theme_classic()
```


